@startuml
actor Client
participant "Payment Engine" as PE
participant "Integration Orchestration MS" as IO
participant "Qualification Plugin" as Qual
participant "Posting Plugin" as Post
participant "Fraud Plugin" as Fraud
participant "Alert Plugin" as Alert
queue "Kafka Topic (PE->IO)" as KafkaIn
queue "Kafka Topic (IO->PE)" as KafkaOut
participant CIF
participant Deposit
participant IFMX
participant Titan

Client -> PE: Initiate Payment (Request)
PE -> IO: Send Common Payload

alt Synchronous Flow
    IO -> Qual: Validate, Enrich, Balance Check
    Qual -> CIF: Fetch CIF & Balance
    CIF --> Qual: CIF Details
    Qual --> IO: Enriched Payload
    
    IO -> Post: Deposit Posting
    Post -> Deposit: Post Transaction
    Deposit --> Post: Success/Failure
    
    IO -> Fraud: Fraud Check
    Fraud -> IFMX: Fraud Validation
    IFMX --> Fraud: Result
    
    IO -> Alert: Trigger Alert
    Alert -> Titan: Send Notification
    Titan --> Alert: Ack
    
    IO --> PE: Aggregated Response
    PE --> Client: Payment Result
end

alt Asynchronous Flow
    PE -> KafkaIn: Publish Payment Payload
    IO <- KafkaIn: Listener consumes Payload
    
    IO -> Qual: Validate, Enrich, Balance Check
    Qual -> CIF: Fetch CIF & Balance
    CIF --> Qual: CIF Details
    Qual --> IO: Enriched Payload
    
    IO -> Post: Deposit Posting
    Post -> Deposit: Post Transaction
    Deposit --> Post: Success/Failure
    
    IO -> Fraud: Fraud Check
    Fraud -> IFMX: Fraud Validation
    IFMX --> Fraud: Result
    
    IO -> Alert: Trigger Alert
    Alert -> Titan: Send Notification
    Titan --> Alert: Ack
    
    IO -> KafkaOut: Publish Final Response
    PE <- KafkaOut: Listener consumes Response
    PE --> Client: Send Payment Result Ack
end
@enduml
